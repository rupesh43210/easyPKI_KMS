{% extends "base.html" %}

{% block title %}System Settings{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fas fa-cog"></i> System Settings</h2>
            <p class="text-muted">Configure PKI/KMS system settings and preferences</p>
            <hr>
        </div>
    </div>

    <div class="row">
        <!-- PKI Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-certificate"></i> PKI Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('web.settings') }}">
                        <input type="hidden" name="settings_type" value="pki">
                        <div class="mb-3">
                            <label class="form-label">Default Certificate Validity (Days)</label>
                            <input type="number" class="form-control" name="cert_validity" 
                                   value="{{ pki_settings.get('default_cert_validity', 365) }}" 
                                   min="1" max="7300" required>
                            <small class="text-muted">Default validity period for new certificates</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Default Key Size (bits)</label>
                            <select class="form-select" name="key_size" required>
                                <option value="2048" {% if pki_settings.get('default_key_size', 2048) == 2048 %}selected{% endif %}>2048 bits</option>
                                <option value="3072" {% if pki_settings.get('default_key_size', 2048) == 3072 %}selected{% endif %}>3072 bits</option>
                                <option value="4096" {% if pki_settings.get('default_key_size', 2048) == 4096 %}selected{% endif %}>4096 bits</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Certificate Organization</label>
                            <input type="text" class="form-control" name="organization" 
                                   value="{{ pki_settings.get('organization', 'Your Organization') }}" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save PKI Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- KMS Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-key"></i> KMS Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('web.settings') }}">
                        <input type="hidden" name="settings_type" value="kms">
                        <div class="mb-3">
                            <label class="form-label">Default Key Rotation (Days)</label>
                            <input type="number" class="form-control" name="rotation_days" 
                                   value="{{ kms_settings.get('default_rotation_days', 90) }}" 
                                   min="30" max="365" required>
                            <small class="text-muted">Automatic key rotation period</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Default Algorithm</label>
                            <select class="form-select" name="algorithm" required>
                                <option value="AES-256" {% if kms_settings.get('default_algorithm', 'AES-256') == 'AES-256' %}selected{% endif %}>AES-256 (Symmetric)</option>
                                <option value="AES-128" {% if kms_settings.get('default_algorithm', 'AES-256') == 'AES-128' %}selected{% endif %}>AES-128 (Symmetric)</option>
                                <option value="RSA-2048" {% if kms_settings.get('default_algorithm', 'AES-256') == 'RSA-2048' %}selected{% endif %}>RSA-2048 (Asymmetric)</option>
                                <option value="RSA-4096" {% if kms_settings.get('default_algorithm', 'AES-256') == 'RSA-4096' %}selected{% endif %}>RSA-4096 (Asymmetric)</option>
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="auto_rotation" name="auto_rotation"
                                   {% if kms_settings.get('auto_rotation_enabled', True) %}checked{% endif %}>
                            <label class="form-check-label" for="auto_rotation">
                                Enable automatic key rotation
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save KMS Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Security Settings -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Security Settings</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('web.settings') }}">
                        <input type="hidden" name="settings_type" value="security">
                        <div class="mb-3">
                            <label class="form-label">Session Timeout (Minutes)</label>
                            <input type="number" class="form-control" name="session_timeout" 
                                   value="{{ security_settings.get('session_timeout', 30) }}" 
                                   min="5" max="1440" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Password Policy</label>
                            <select class="form-select" name="password_policy" required>
                                <option value="standard" {% if security_settings.get('password_policy', 'standard') == 'standard' %}selected{% endif %}>Standard (8+ chars, mixed case)</option>
                                <option value="strong" {% if security_settings.get('password_policy', 'standard') == 'strong' %}selected{% endif %}>Strong (12+ chars, mixed case, symbols)</option>
                                <option value="very_strong" {% if security_settings.get('password_policy', 'standard') == 'very_strong' %}selected{% endif %}>Very Strong (16+ chars, all types)</option>
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="require_2fa" name="require_2fa"
                                   {% if security_settings.get('require_2fa', False) %}checked{% endif %}>
                            <label class="form-check-label" for="require_2fa">
                                Require Two-Factor Authentication (2FA)
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="audit_all" name="audit_all"
                                   {% if security_settings.get('audit_all_actions', True) %}checked{% endif %}>
                            <label class="form-check-label" for="audit_all">
                                Log all user actions
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Save Security Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> System Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Version:</strong></td>
                            <td>1.0.0</td>
                        </tr>
                        <tr>
                            <td><strong>Database:</strong></td>
                            <td>SQLite</td>
                        </tr>
                        <tr>
                            <td><strong>PKI Status:</strong></td>
                            <td><span class="badge bg-success">Operational</span></td>
                        </tr>
                        <tr>
                            <td><strong>KMS Status:</strong></td>
                            <td><span class="badge bg-success">Operational</span></td>
                        </tr>
                        <tr>
                            <td><strong>Root CA:</strong></td>
                            <td><span class="badge bg-success">Active</span></td>
                        </tr>
                        <tr>
                            <td><strong>Intermediate CA:</strong></td>
                            <td><span class="badge bg-success">Active</span></td>
                        </tr>
                    </table>
                    
                    <hr>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('web.audit') }}" class="btn btn-outline-info">
                            <i class="fas fa-list"></i> View Audit Logs
                        </a>
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-download"></i> Export Configuration (Coming Soon)
                        </button>
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#resetModal">
                            <i class="fas fa-redo"></i> Reset System
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup & Maintenance -->
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> Backup & Maintenance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" disabled>
                                <i class="fas fa-download"></i><br>Backup Database
                            </button>
                            <small class="text-muted">Coming Soon</small>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100" disabled>
                                <i class="fas fa-upload"></i><br>Restore Database
                            </button>
                            <small class="text-muted">Coming Soon</small>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning w-100" disabled>
                                <i class="fas fa-broom"></i><br>Clean Expired
                            </button>
                            <small class="text-muted">Coming Soon</small>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-info w-100" disabled>
                                <i class="fas fa-chart-bar"></i><br>System Report
                            </button>
                            <small class="text-muted">Coming Soon</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Settings marked as "Coming Soon" are placeholders for future functionality. 
        Current system configuration is managed through config files.
    </div>
</div>

<!-- Reset System Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="resetModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Reset System
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> <strong>WARNING:</strong> This action cannot be undone!
                </div>
                
                <form id="resetForm" method="POST" action="{{ url_for('web.reset_system') }}">
                    <div class="mb-4">
                        <label class="form-label fw-bold">Select Reset Type:</label>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="reset_type" id="resetSettings" value="settings" checked>
                            <label class="form-check-label" for="resetSettings">
                                <strong>Reset Settings Only</strong>
                                <p class="text-muted small mb-0">Resets PKI/KMS/Security settings to factory defaults. Keeps all certificates, keys, users, and data.</p>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="reset_type" id="resetAll" value="all">
                            <label class="form-check-label" for="resetAll">
                                <strong class="text-danger">Full System Reset (DANGEROUS!)</strong>
                                <p class="text-danger small mb-0">
                                    <i class="fas fa-skull-crossbones"></i> Revokes all certificates, disables all keys, deletes all users (except you), resets all settings. 
                                    <strong>All data will be marked as inactive! Audit logs preserved.</strong>
                                </p>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="reset_type" id="resetComplete" value="complete">
                            <label class="form-check-label" for="resetComplete">
                                <strong class="text-danger">Complete Reset + Clear Audit Logs (NUCLEAR!)</strong>
                                <p class="text-danger small mb-0">
                                    <i class="fas fa-radiation"></i> Everything from Full Reset + <strong>DELETES ALL AUDIT LOGS!</strong> 
                                    <strong>Complete loss of audit trail - use with extreme caution!</strong>
                                </p>
                            </label>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold text-danger">
                            Confirmation Required: Type "RESET" to confirm
                        </label>
                        <input type="text" class="form-control form-control-lg" name="confirmation_code" 
                               id="confirmationCode" placeholder="Type RESET here" required>
                        <small class="form-text text-muted">This action requires explicit confirmation</small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>What will happen:</strong>
                        <ul class="mb-0 mt-2" id="resetEffects">
                            <li>Settings will be reset to defaults</li>
                            <li>All custom configurations will be lost</li>
                            <li>Audit log will record this action</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmResetBtn" onclick="submitReset()" disabled>
                    <i class="fas fa-redo"></i> Confirm Reset
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Enable/disable reset button based on confirmation code
document.getElementById('confirmationCode').addEventListener('input', function() {
    const btn = document.getElementById('confirmResetBtn');
    if (this.value === 'RESET') {
        btn.disabled = false;
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-danger');
    } else {
        btn.disabled = true;
    }
});

// Update warning text based on reset type
document.querySelectorAll('input[name="reset_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const effectsList = document.getElementById('resetEffects');
        if (this.value === 'settings') {
            effectsList.innerHTML = `
                <li>Settings will be reset to defaults</li>
                <li>All custom configurations will be lost</li>
                <li>Certificates, keys, and users will NOT be affected</li>
                <li>Audit log will record this action</li>
            `;
        } else {
            effectsList.innerHTML = `
                <li class="text-danger"><strong>All certificates will be revoked</strong></li>
                <li class="text-danger"><strong>All encryption keys will be disabled</strong></li>
                <li class="text-danger"><strong>All users except you will be deleted</strong></li>
                <li class="text-danger"><strong>Settings will be reset to defaults</strong></li>
                <li>Audit log will record this action (data preserved for compliance)</li>
            `;
        }
    });
});

function submitReset() {
    if (confirm('Are you ABSOLUTELY SURE you want to reset the system? This cannot be undone!')) {
        document.getElementById('resetForm').submit();
    }
}
</script>

{% endblock %}
